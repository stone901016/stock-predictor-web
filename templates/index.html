<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>股票分析系統</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h1>📈 股票分析系統</h1>

  <form id="analyzeForm">
    <label>股票代號：<input type="text" id="symbol" required></label><br>

    <label>選擇資料區間：</label>
    <select id="date_mode">
      <option value="range">📆 自訂起訖日期</option>
      <option value="year">📅 最近幾年</option>
      <option value="all">🕰️ 從上市至今</option>
    </select><br>

    <div id="date_range">
      <label>起始日期：<input type="date" id="start_date"></label>
      <label>結束日期：<input type="date" id="end_date"></label><br>
    </div>

    <div id="year_range" style="display:none">
      <label>最近幾年：<input type="number" id="years" value="3" min="1"></label><br>
    </div>

    <label>資料頻率：
      <select id="interval">
        <option value="1d">日資料</option>
        <option value="1wk">週資料</option>
        <option value="1mo">月資料</option>
      </select>
    </label><br>

    <button type="submit">開始分析</button>
  </form>

  <div id="result"></div>

  <script>
    const dateMode = document.getElementById('date_mode');
    dateMode.addEventListener('change', function () {
      document.getElementById('date_range').style.display = this.value === 'range' ? 'block' : 'none';
      document.getElementById('year_range').style.display = this.value === 'year' ? 'block' : 'none';
    });

    document.getElementById('analyzeForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const symbol = document.getElementById('symbol').value.trim().toUpperCase();
      const date_mode = document.getElementById('date_mode').value;
      const interval = document.getElementById('interval').value;

      let start_date = null, end_date = null, years = null;
      if (date_mode === 'range') {
        start_date = document.getElementById('start_date').value;
        end_date = document.getElementById('end_date').value;
      } else if (date_mode === 'year') {
        years = parseInt(document.getElementById('years').value);
      }

      document.getElementById('result').innerHTML = '📊 分析中...';

      try {
        const res = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ symbol, date_mode, start_date, end_date, years, interval })
        });

        const data = await res.json();

        if (data.error) {
          document.getElementById('result').innerHTML = `<p style='color:red;'>錯誤：${data.error}</p>`;
          return;
        }

        let html = `<h2>${symbol} 分析結果</h2>`;
        html += `<p>每年平均波動度：</p><pre>${JSON.stringify(data.volatility, null, 2)}</pre>`;
        html += `<p>每年平均報酬率：</p><pre>${JSON.stringify(data.avg_return, null, 2)}</pre>`;
        html += `<p>最大回測：${(data.max_drawdown * 100).toFixed(2)}%</p>`;
        html += `<p>Sharpe Ratio：${data.sharpe_ratio.toFixed(2)}</p>`;
        html += `<p>Alpha：${data.alpha?.toFixed(4) ?? 'N/A'}</p>`;
        html += `<p>Beta：${data.beta?.toFixed(4) ?? 'N/A'}</p>`;
        html += `<img src="data:image/png;base64,${data.nav_img}" alt="NAV 圖">`;

        document.getElementById('result').innerHTML = html;
      } catch (err) {
        document.getElementById('result').innerHTML = `<p style='color:red;'>錯誤：${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
